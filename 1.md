// require('dotenv').config();
const express = require('express');
const mongoose = require('mongoose');
const cors = require('cors');
const app = express();
const Booking = require("./models/data.js");
const path = require("path");
const bodyParser = require('body-parser');


// Middleware
app.use(cors());
app.use(express.json()); // Use built-in Express JSON parser
// app.use(express.static('public')); // Serve static files
app.use(express.static(path.join(__dirname, 'public')));
app.use(bodyParser.urlencoded({ extended: true }));
app.use(bodyParser.json());

// Fix Mongoose strictQuery deprecation warning
mongoose.set('strictQuery', true);

const MONGO_URI = "mongodb://127.0.0.1:27017/HairArtistry";
main()
.then((err) =>{
    console.log("connected to DB");
    })
    .catch((err) =>{
        console.log(err);        
    });
async function main (){
    await mongoose.connect(MONGO_URI);
}

app.get("/", (req, res)=>{
    res.send("hi, i am root");
});

// app.get("/testListing", async (req, res) => {
//   let BookingSchema = new Booking({
    
//     name: "brijesh",
//     phone: 6307830082,
//     email: "brijesh@gmail.com",
//     service: "haircut",
//     date: "20/05/2025",
//     time: "02:05",
//     barber: "any",
//     notes: 'nothing',
//   });

//   await BookingSchema.save();
//   console.log("sample was saved");
//   res.send("successful testing");
// });



// Booking API Routes
app.post('/api/bookings', async (req, res) => {
    console.log("Recieved data:" , req.body);
    
    try {
        // console.log("Incoming booking request:", req.body); // Log incoming data

        // const { name, phone, email, service, date, time, barber, notes } = req.body;
        
        // if (!name || !phone || !email || !service || !date || !time) {
        //     return res.status(400).json({ error: "Missing required fields" });
        // }

        // const booking = new Booking({ name, phone, email, service, date: new Date(date), time, barber, notes });
        const booking = new Booking(req.body);
        await booking.save();
        
        res.status(200).json({ message: 'Booking created successfully' });
    } catch (error) {
        console.error("Error creating booking:", error);
        // res.status(400).json({ error: error.message || "Bad Request" });
        res.status(400).json({ message: 'Error saving booking', error });
    }
});

app.get('/api/bookings', async (req, res) => {
    try {
        const bookings = await Booking.find().sort({ createdAt: -1 });
        res.json(bookings);
    } catch (error) {
        console.error("Error fetching bookings:", error);
        res.status(500).json({ error: "Internal Server Error" });
    }
});

// Contact Form API
app.post('/api/contact', async (req, res) => {
    try {
        const { name, email, message } = req.body;
        if (!name || !email || !message) {
            return res.status(400).json({ error: "Missing required fields" });
        }
        const contact = new Contact(req.body);
        await contact.save();
        res.status(201).json({ message: 'Message sent successfully' });
    } catch (error) {
        console.error("Error saving contact message:", error);
        res.status(400).json({ error: error.message || "Bad Request" });
    }
});

// Newsletter Schema
const subscriberSchema = new mongoose.Schema({
    email: { type: String, unique: true },
    createdAt: { type: Date, default: Date.now }
});

const Subscriber = mongoose.model('Subscriber', subscriberSchema);

// Email Validation Function
const validateEmail = (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

// Newsletter Subscription API
app.post('/api/subscribe', async (req, res) => {
    try {
        const { email } = req.body;
        if (!email || !validateEmail(email)) {
            return res.status(400).json({ error: "Invalid email address" });
        }
        const subscriber = new Subscriber({ email });
        await subscriber.save();
        res.status(201).json({ message: 'Subscribed successfully' });
    } catch (error) {
        console.error("Subscription error:", error);
        if (error.code === 11000) {
            res.status(400).json({ error: 'Email already subscribed' });
        } else {
            res.status(400).json({ error: error.message || "Bad Request" });
        }
    }
});

// Admin Panel Route
app.get('/admin', async (req, res) => {
    try {
        const bookings = await Booking.find().sort({ date: 1 });

        res.setHeader("Content-Type", "text/html");
        res.send(`
            <h1>Admin Panel</h1>
            <table border="1">
                <tr>
                    <th>Name</th>
                    <th>Service</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Barber</th>
                    <th>Status</th>
                </tr>
                ${bookings.map(booking => `
                    <tr>
                        <td>${booking.name}</td>
                        <td>${booking.service}</td>
                        <td>${new Date(booking.date).toLocaleDateString()}</td>
                        <td>${booking.time}</td>
                        <td>${booking.barber || 'Any'}</td>
                        <td>${booking.status}</td>
                    </tr>
                `).join('')}
            </table>
        `);
    } catch (error) {
        console.error("Error loading admin panel:", error);
        res.status(500).send("Error loading admin panel");
    }
});

// Catch-All 404 Route
app.use((req, res) => {
    res.status(404).json({ error: "Route Not Found" });
});



// Start Server
app.listen(8080, () => {
    console.log("Server running on port 8080");
});



<!-- javascript code  -->

        // Navbar scroll effect
        window.addEventListener('scroll', function() {
            const navbar = document.getElementById('navbar');
            if (window.scrollY > 50) {
                navbar.classList.add('scrolled');
            } else {
                navbar.classList.remove('scrolled');
            }
        });

        // Mobile menu toggle
        document.querySelector('.burger').addEventListener('click', function() {
            document.querySelector('.nav-links').classList.toggle('active');
        });

        // Smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({
                    behavior: 'smooth'
                });
                
                // Close mobile menu if open
                document.querySelector('.nav-links').classList.remove('active');
            });
        });

        // Scroll to section function
        function scrollToSection(sectionId) {
            document.getElementById(sectionId).scrollIntoView({
                behavior: 'smooth'
            });
        }

        // Booking form functions
        function openBookingForm(serviceName) {
            const modal = document.getElementById('bookingModal');
            const serviceTitle = document.getElementById('serviceTitle');
            const serviceSelect = document.getElementById('service');
            
            serviceTitle.textContent = `Book ${serviceName}`;
            
            // Set the service in the dropdown
            if (serviceName && serviceSelect) {
                for (let i = 0; i < serviceSelect.options.length; i++) {
                    if (serviceSelect.options[i].text.includes(serviceName)) {
                        serviceSelect.selectedIndex = i;
                        break;
                    }
                }
            }
            
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevent scrolling when modal is open
        }

        function closeBookingForm() {
            document.getElementById('bookingModal').style.display = 'none';
            document.body.style.overflow = 'auto'; // Re-enable scrolling
        }

        // Gallery modal functions
        function openGalleryModal(imgSrc) {
            const modal = document.getElementById('galleryModal');
            const img = document.getElementById('galleryModalImg');
            
            img.src = imgSrc;
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeGalleryModal() {
            document.getElementById('galleryModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const bookingModal = document.getElementById('bookingModal');
            const galleryModal = document.getElementById('galleryModal');
            
            if (event.target == bookingModal) {
                closeBookingForm();
            }
            
            if (event.target == galleryModal) {
                closeGalleryModal();
            }
        }

        // Form submissions
        document.getElementById('bookingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            
            const name = document.getElementById('name').value;
            const service = document.getElementById('service').value;
            
            alert(`Thank you, ${name}! Your booking request for ${service} has been received. 
                We'll contact you shortly to confirm.`);
            
            // Reset form and close modal
            this.reset();
            closeBookingForm();
        });

        document.getElementById('contactForm').addEventListener('submit', function(e) {
            e.preventDefault();
            alert('Thank you for your message! We will get back to you soon.');
            this.reset();
        });

        document.getElementById('newsletterForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = this.querySelector('input[type="email"]').value;
            alert(`Thank you for subscribing with ${email}!`);
            this.reset();
        });

    //    booking form
      // Wait for the page to fully load
document.addEventListener("DOMContentLoaded", function () {

    const bookingForm = document.getElementById("bookingForm");

    if (!bookingForm) {
        console.error("Booking form not found!");
        return;
    }

    // Set minimum date to today's date
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months start from 0
    const dd = String(today.getDate()).padStart(2, '0');
    document.getElementById("date").min = `${yyyy}-${mm}-${dd}`;

    // Form submit event listener
    bookingForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        // Gather all form data
        const name = document.getElementById("name").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const email = document.getElementById("email").value.trim();
        const service = document.getElementById("service").value.trim();
        const date = document.getElementById("date").value;
        const time = document.getElementById("time").value.trim();
        const barber = document.getElementById("barber").value.trim();
        const notes = document.getElementById("notes").value.trim();

        // Basic required fields check
        if (!name || !phone || !email || !service || !date || !time) {
            alert("Please fill in all required fields before submitting!");
            return;
        }

        // Prepare data for the server
        const bookingData = { name, phone, email, service, date, time, barber, notes };

        try {
            const response = await fetch('/api/booking', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bookingData)
            });

            const result = await response.json();

            if (response.ok) {
                alert(result.message || "Booking successfully submitted!");
                bookingForm.reset(); // clear form
                if (typeof closeBookingForm === "function") {
                    closeBookingForm(); // close modal if function exists
                }
            } else {
                alert(result.message || "Something went wrong. Please try again!");
            }
        } catch (error) {
            console.error("Error submitting booking:", error);
            alert("Error sending booking request. Please check your connection.");
        }
    });
});
// form validation
document.getElementById("bookingForm").addEventListener("submit", function(event) {
    event.preventDefault(); // Stop form for now
    let isValid = true;

    // Clear previous errors
    document.querySelectorAll(".error-message").forEach(el => el.remove());

    // Grab fields
    let name = document.getElementById("name").value.trim();
    let phone = document.getElementById("phone").value.trim();
    let email = document.getElementById("email").value.trim();
    let service = document.getElementById("service").value;
    let date = document.getElementById("date").value;
    let time = document.getElementById("time").value;

    // Validate Full Name
    if (name === "") {
        showError("name", "Full name is required.");
        isValid = false;
    }

    // Validate Phone Number (10 digits only)
    if (!/^\d{10}$/.test(phone)) {
        showError("phone", "Enter a valid 10-digit phone number.");
        isValid = false;
    }

    // Validate Email
    if (!/^\S+@\S+\.\S+$/.test(email)) {
        showError("email", "Enter a valid email address.");
        isValid = false;
    }

    // Validate Service Selection
    if (service === "") {
        showError("service", "Please select a service.");
        isValid = false;
    }

    // Validate Date (must be today or future)
    let today = new Date();
    today.setHours(0,0,0,0);  // ignore time part
    let selectedDate = new Date(date);
    if (selectedDate < today) {
        showError("date", "Please select a valid date.");
        isValid = false;
    }

    // Validate Time (not empty)
    if (time === "") {
        showError("time", "Please select a preferred time.");
        isValid = false;
    }

    // If everything is valid, submit
    if (isValid) {
        this.submit();
    }
});

// Helper to show error message
function showError(fieldId, message) {
    let field = document.getElementById(fieldId);
    let error = document.createElement("div");
    error.className = "error-message";
    error.style.color = "red";
    error.style.fontSize = "0.85em";
    error.style.marginTop = "5px";
    error.textContent = message;
    field.parentNode.appendChild(error);
}
            
        // contact form
            document.getElementById('contactForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = {
                    name: document.getElementById('contact-name').value,
                    email: document.getElementById('contact-email').value,
                    subject: document.getElementById('contact-subject').value,
                    message: document.getElementById('contact-message').value
                };
        
                try {
                    const response = await fetch('/api/contact', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
        
                    const data = await response.json();
                    
                    if (response.ok) {
                        alert('Thank you for your message! We will get back to you soon.');
                        this.reset();
                    } else {
                        throw new Error(data.error || 'Failed to send message');
                    }
                } catch (error) {
                    alert(`Error: ${error.message}`);
                    console.error('Contact form error:', error);
                }
            });
             
        // Newsletter form
            document.getElementById('newsletterForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const email = this.querySelector('input[type="email"]').value;
                
                try {
                    const response = await fetch('/api/subscribe', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email })
                    });
        
                    const data = await response.json();
                    
                    if (response.ok) {
                        alert(`Thank you for subscribing with ${email}!`);
                        this.reset();
                    } else {
                        throw new Error(data.error || 'Failed to subscribe');
                    }
                } catch (error) {
                    alert(`Error: ${error.message}`);
                    console.error('Subscription error:', error);
                }
            });
        


document.addEventListener('DOMContentLoaded', function() {
    // Elements
    const openCameraBtn = document.getElementById('openCameraBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');
    const cameraFeed = document.getElementById('cameraFeed');
    const photoCanvas = document.getElementById('photoCanvas');
    const placeholder = document.getElementById('placeholder');
    const captureBtn = document.getElementById('captureBtn');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const results = document.getElementById('results');
    const hairstyleSuggestions = document.getElementById('hairstyleSuggestions');
    const resetBtn = document.getElementById('resetBtn'); // Reset button added

    let stream = null;
    
    // Face shapes and recommended hairstyles with unique images
    const hairstyleRecommendations = {'oval': [
            { name: 'Classic Pompadour', img: 'img\men bun cut.jpg' },
            { name: 'Side Part', img: 'https://www.dmarge.com/wp-content/uploads/2014/09/Last-Import-044.jpg' },
            { name: 'Textured Crop', img: 'https://example.com/texturedcrop.jpg'}
        ],
        'round': [
            { name: 'Angular Fade', img: 'https://example.com/angularfade.jpg' },
            { name: 'High Fade', img: 'https://i.pinimg.com/originals/9d/9a/e9/9d9ae9a0c5cb2cfb1375b57dd836474c.jpg' },
            { name: 'modern mullet cut', img: 'https://i.pinimg.com/originals/2d/59/da/2d59da702663712a7c9c53375a6a472a.jpg' }
        ],
        'square': [
            { name: 'Buzz Cut', img: 'https://i.pinimg.com/originals/9d/9a/e9/9d9ae9a0c5cb2cfb1375b57dd836474c.jpg' },
            { name: 'French Crop', img: 'img\slick back.jpg' },
            { name: 'Slick Back', img: 'img\slick back.jpg' }
        ],
        'heart': [
            { name: 'Side Swept', img: 'https://www.dmarge.com/wp-content/uploads/2014/09/Last-Import-044.jpg' },
            { name: 'Taper Fade', img: 'https://i.pinimg.com/originals/ff/3f/11/ff3f11694a519bdedbb7f9bf73f9d1a5.jpg' },
            { name: 'Long Top Short Sides', img: 'https://i.pinimg.com/originals/98/30/f3/9830f3c7e7cf78f24d157f1d9967ae64.jpg' }
        ],
        'diamond': [
            { name: 'Fringe', img: 'https://haircutinspiration.com/wp-content/uploads/Medium-Slick-Back-1-1.jpg' },
            { name: 'Comb Over', img: 'https://i.pinimg.com/originals/98/30/f3/9830f3c7e7cf78f24d157f1d9967ae64.jpg' },
            { name: 'Undercut', img: 'img\wolf cut.jpg' }
        ]
    };

    // Open camera
    openCameraBtn.addEventListener('click', async function() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            cameraFeed.srcObject = stream;
            cameraFeed.style.display = 'block';
            placeholder.style.display = 'none';
            captureBtn.style.display = 'block';
            analyzeBtn.style.display = 'none';
        } catch (err) {
            alert('Could not access camera: ' + err.message);
        }
    });

    // Upload photo
    uploadBtn.addEventListener('click', function() {
        fileInput.click();
    });

    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length) {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    photoCanvas.width = img.width;
                    photoCanvas.height = img.height;
                    const ctx = photoCanvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    
                    photoCanvas.style.display = 'block';
                    placeholder.style.display = 'none';
                    analyzeBtn.style.display = 'block';
                    
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                        cameraFeed.style.display = 'none';
                    }
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    // Capture photo from camera
    captureBtn.addEventListener('click', function() {
        photoCanvas.width = cameraFeed.videoWidth;
        photoCanvas.height = cameraFeed.videoHeight;
        const ctx = photoCanvas.getContext('2d');
        ctx.drawImage(cameraFeed, 0, 0, photoCanvas.width, photoCanvas.height);
        
        photoCanvas.style.display = 'block';
        cameraFeed.style.display = 'none';
        captureBtn.style.display = 'none';
        analyzeBtn.style.display = 'block';
    });

    // Analyze face and recommend hairstyles
    analyzeBtn.addEventListener('click', function() {
        // Simulate face shape detection
        const faceShapes = Object.keys(hairstyleRecommendations);
        const randomShape = faceShapes[Math.floor(Math.random() * faceShapes.length)];

        // Display results
        results.style.display = 'block';
        hairstyleSuggestions.innerHTML = '';

        // Add detected face shape
        const shapeElement = document.createElement('div');
        shapeElement.innerHTML = `
            <p style="grid-column: 1/-1; text-align: center; font-weight: bold;">
                Detected Face Shape: <span style="color: #d4af37;">${randomShape.toUpperCase()}</span>
            </p>
        `;
        hairstyleSuggestions.appendChild(shapeElement);

        // Add recommended hairstyles with unique images
        hairstyleRecommendations[randomShape].forEach(hairstyle => {
            const hairstyleElement = document.createElement('div');
            hairstyleElement.innerHTML = `
                <div style="background: #f9f9f9; padding: 1rem; border-radius: 5px; text-align: center;">
                    <img src="${hairstyle.img}" 
                         alt="${hairstyle.name}" 
                         style="width: 100%; height: 120px; object-fit: cover; border-radius: 3px; margin-bottom: 0.5rem;">
                    <p style="font-weight: 500;">${hairstyle.name}</p>
                    <button class="book-btn" onclick="openBookingForm('${hairstyle.name}')" style="margin-top: 0.5rem;">Book This Style</button>
                </div>
            `;
            hairstyleSuggestions.appendChild(hairstyleElement);
        });

        // Show reset button
        resetBtn.style.display = 'block';

        // Scroll to results
        results.scrollIntoView({ behavior: 'smooth' });
    });

    // // Reset button functionality
    // resetBtn.addEventListener('click', function() {
    //     // Hide elements
    //     results.style.display = 'none';
    //     photoCanvas.style.display = 'none';
    //     cameraFeed.style.display = 'none';
    //     captureBtn.style.display = 'none';
    //     analyzeBtn.style.display = 'none';
    //     resetBtn.style.display = 'none';
        
    //     // Clear canvas
    //     const ctx = photoCanvas.getContext('2d');
    //     ctx.clearRect(0, 0, photoCanvas.width, photoCanvas.height);

    //     // Show placeholder again
    //     placeholder.style.display = 'block';

    //     // Stop the camera if active
    //     if (stream) {
    //         stream.getTracks().forEach(track => track.stop());
    //     }

    //     // Reset file input
    //     fileInput.value = '';
    // });

    // Clean up camera when leaving the section
    document.querySelector('#virtual-tryon').addEventListener('mouseleave', function() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            cameraFeed.style.display = 'none';
        }
    });
});
// reset button
document.getElementById("myButton").addEventListener("click", function() {
    console.log("Button clicked!");
});



// nothing


document.addEventListener("DOMContentLoaded", function () {
    let element = document.querySelector("#someElement");
    if (element) {
        element.addEventListener("click", () => {
            console.log("Clicked!");
        });
    } else {
        console.error("Element not found!");
    }
});

// fetch("http://localhost:8080/api/bookings", {
//     method: "POST",
//     headers: { "Content-Type": "application/json" },
//     body: JSON.stringify({ name:"jhon" , date: "2025-04-03" }),
// })
// .then(response => {
//     if (!response.ok) {
//         throw new Error(`HTTP error! Status: ${response.status}`);
//     }
//     return response.json();
// })
// .then(data => console.log("Booking Successful:", data))
// .catch(error => console.error("Error submitting booking:", error));

// Ensure querySelector uses valid IDs
let validElement = document.querySelector("#SubmitButton");
if (validElement) {
    validElement.addEventListener("click", () => {
        console.log("Valid element clicked!");
    });
} else {
    console.error("Valid element not found!");
}

